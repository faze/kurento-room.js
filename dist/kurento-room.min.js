(function(){var a;a=function(){function a(b,c){var d,e,f,g,h,i;return this instanceof a?(g=this,h=void 0,i=new WebSocket(b),i.onopen=function(){c(null,g)},i.onerror=function(a){c(a.data)},i.onclose=function(){console.log("Connection Closed")},d={request_timeout:5e4},e=new RpcBuilder(RpcBuilder.packers.JsonRPC,d,i,function(a){switch(console.info("Received request: "+JSON.stringify(a)),a.method){case"participantJoined":onParticipantJoined(a.params);break;case"participantPublished":onParticipantPublished(a.params);break;case"participantUnpublished":onParticipantLeft(a.params);break;case"participantLeft":onParticipantLeft(a.params);break;case"sendMessage":onNewMessage(a.params);break;case"iceCandidate":iceCandidateEvent(a.params);break;case"roomClosed":onRoomClosed(a.params);break;case"mediaError":onMediaError(a.params);break;default:console.error("Unrecognized request: "+JSON.stringify(a))}}),void(f=void 0)):new a(b,c)}return a.prototype.onParticipantJoined=function(a){void 0!==room&&room.onParticipantJoined(a)},a.prototype.onParticipantPublished=function(a){void 0!==room&&room.onParticipantPublished(a)},a.prototype.onParticipantLeft=function(a){void 0!==room&&room.onParticipantLeft(a)},a.prototype.onNewMessage=function(a){void 0!==room&&room.onNewMessage(a)},a.prototype.iceCandidateEvent=function(a){void 0!==room&&room.recvIceCandidate(a)},a.prototype.onRoomClosed=function(a){void 0!==room&&room.onRoomClosed(a)},a.prototype.onMediaError=function(a){void 0!==room&&room.onMediaError(a)},a.setRpcParams=function(a){var b;b=a},a.sendRequest=function(a,b,c){var d;if(rpcParams&&"null"!==rpcParams&&"undefined"!==rpcParams)for(d in rpcParams)rpcParams.hasOwnProperty(d)&&(b[d]=rpcParams[d]);rpc.encode(a,b,c),console.log('Sent request: { method:"'+a+'", params: '+JSON.stringify(b)+" }")},a.prototype.close=function(a){void 0!==room&&room.leave(a),ws.close()},a.prototype.disconnectParticipant=function(a){void 0!==room&&room.disconnect(a)},a.prototype.Stream=function(a,b){return b.participant=a.getLocalParticipant(),new d(that,!0,a,b)},a.prototype.Room=function(a){var b,d;return b=new c(that,a),d=a.userName,b},a.prototype.sendMessage=function(a,b,c){this.sendRequest("sendMessage",{message:c,userMessage:b,roomMessage:a},function(a,b){var c;a?console.error(a):c=!1})},a.prototype.sendCustomRequest=function(a,b){this.sendRequest("customRequest",a,b)},a}();var b;b=function(){function a(a,b,c,e){var f,g,h,i,j;if(this.kurento=a,this.local=b,this.room=c,this.options=e,j=this,g=options.id,i={},options.streams)for(f=0;f<options.streams.length;)h=new d(kurento,!1,room,{id:options.streams[f].id,participant:j}),addStream(h),f++}return a.prototype.setId=function(a){var b;b=a},a.prototype.addStream=function(a){streams[a.getID()]=a,room.getStreams()[a.getID()]=a},a.prototype.getStreams=function(){return streams},a.prototype.dispose=function(){var a;for(a in streams)streams[a].dispose()},a.prototype.getID=function(){return id},a.prototype.sendIceCandidate=function(a){local?console.debug("Local"):console.debug("Remote","candidate for",that.getID(),JSON.stringify(a)),kurento.sendRequest("onIceCandidate",{endpointName:that.getID(),candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex},function(a,b){a&&console.error("Error sending ICE candidate: "+JSON.stringify(a))})},a}();var c;c=function(){function a(a,c){var d,e,f;f=this,f.name=c.room,d=new EventEmitter,this.streams={},this.participants={},this.connected=!1,this.localParticipant=void 0,e=c.subscribeToStreams||!0,this.localParticipant=new b(a,!0,f,{id:c.user}),this.participants[c.user]=this.localParticipant}return a.prototype.getLocalParticipant=function(){return this.localParticipant},a.prototype.addEventListener=function(a,b){ee.addListener(a,b)},a.prototype.emitEvent=function(a,b){ee.emitEvent(a,b)},a.prototype.connect=function(){kurento.sendRequest("joinRoom",{user:options.user,room:options.room},function(a,c){var d,e,f,g,h,i;if(a)ee.emitEvent("error-room",[{error:a}]);else{for(this.connected=!0,d=c.value,i={participants:[],streams:[]},g=d.length,e=0;g>e;){h=new b(kurento,!1,that,d[e]),this.participants[h.getID()]=h,i.participants.push(h),this.streams=h.getStreams();for(f in this.streams)i.streams.push(this.streams[f]),subscribeToStreams&&this.streams[f].subscribe();e++}ee.emitEvent("room-@connected",[i])}})},a.prototype.subscribe=function(a){a.subscribe()},a.prototype.onParticipantPublished=function(a){var c,d,e,f;d=new b(kurento,!1,that,a),e=d.getID(),e in this.participants?console.log("Publisher found in @participants list by its id",e):console.info("Publisher not found in @participants list by its id",e),this.participants[e]=d,ee.emitEvent("participant-published",[{participant:d}]),this.streams=d.getStreams();for(c in this.streams)f=this.streams[c],subscribeToStreams&&(f.subscribe(),ee.emitEvent("stream-added",[{stream:f}]))},a.prototype.onParticipantJoined=function(a){var c,d;c=new b(kurento,!1,that,a),d=c.getID(),d in this.participants?(log.info("Participant already exists in @participants list with the same id, old:",this.participants[d],", joined now:",c),c=this.participants[d]):(console.log("New participant to @participants list with id",d),this.participants[d]=c),ee.emitEvent("participant-joined",[{participant:c}])},a.prototype.onParticipantLeft=function(a){var b,c;if(c=this.participants[a.name],void 0!==c){delete this.participants[a.name],ee.emitEvent("participant-left",[{participant:c}]),this.streams=c.getStreams();for(b in this.streams)ee.emitEvent("stream-removed",[{stream:this.streams[b]}]);c.dispose()}else console.error("Participant "+a.name+" unknown. Participants: "+JSON.stringify(this.participants))},a.prototype.onNewMessage=function(a){var b,c,d;console.log("New message: "+JSON.stringify(a)),c=a.room,d=a.user,b=a.message,void 0!==d?ee.emitEvent("newMessage",[{room:c,user:d,message:b}]):console.error("User undefined in new message:",a)},a.prototype.recvIceCandidate=function(a){var b,c,d,e;if(b={candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex},d=this.participants[a.endpointName],!d)return console.error("Participant not found for endpoint "+a.endpointName+". Ice candidate will be ignored.",b),!1;this.streams=d.getStreams();for(c in this.streams)if(e=this.streams[c],"webcam"===c){e.getWebRtcPeer().addIceCandidate(b,function(a){return a?void console.error("Error adding candidate: "+a):void 0});break}},a.prototype.onRoomClosed=function(a){var b;console.log("Room closed: "+JSON.stringify(a)),b=a.room,void 0!==b?ee.emitEvent("room-closed",[{room:b}]):console.error("Room undefined in on room closed",a)},a.prototype.onMediaError=function(a){var b;console.error("Media error: "+JSON.stringify(a)),b=a.error,b?ee.emitEvent("error-media",[{error:b}]):console.error("Received undefined media error. Params:",a)},a.prototype.leave=function(a){var b;a=!!a,console.log("Leaving room (forced="+a+")"),this.connected&&!a&&kurento.sendRequest("leaveRoom",function(a,b){a?console.error(a):this.connected=!1});for(b in this.participants)this.participants[b].dispose()},a.prototype.disconnect=function(a){var b;return(b=a.getParticipant())?(delete this.participants[b.getID()],b.dispose(),void(b===this.localParticipant?(console.log("Unpublishing my media (I'm "+b.getID()+")"),delete this.localParticipant,kurento.sendRequest("unpublishVideo",function(a,b){a?console.error(a):console.info("Media unpublished correctly")})):(console.log("Unsubscribing from "+a.getGlobalID()),kurento.sendRequest("unsubscribeFromVideo",{sender:a.getGlobalID()},function(b,c){b?console.error(b):console.info("Unsubscribed correctly from "+a.getGlobalID())})))):(console.error("Stream to disconnect has no participant",a),!1)},a.prototype.getStreams=function(){return this.streams},a}();var d;d=function(){function a(a,b,c,d){var e;this.kurento=a,this.local=b,this.room=c,this.options=d,this.ee=new EventEmitter,e=void 0,this.wrStream=void 0,this.wp=void 0,this.id=void 0,options.id?this.id=options.id:this.id="webcam",this.video=void 0,this.videoElements=[],this.elements=[],this.participant=options.participant,this.showMyRemote=!1}var b;return a.prototype.showSpinner=function(a){var b;b=document.createElement("div"),b.id="progress-"+this.getGlobalID(),b.style.background="center transparent url('img/spinner.gif') no-repeat",document.getElementById(a).appendChild(b)},a.prototype.hideSpinner=function(a){a="undefined"==typeof a?this.getGlobalID():a,$("#progress-"+a).hide()},a.prototype.initWebRtcPeer=function(a){var b;local?(b={videoStream:this.wrStream,onicecandidate:this.participant.sendIceCandidate.bind(this.participant)},this.displayMyRemote()?this.wp=new kurentoUtils.WebRtcPeer.WebRtcPeerSendrecv(b,function(b){return b?console.error(b):void this.generateOffer(a.bind(this))}):this.wp=new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(b,function(b){return b?console.error(b):void this.generateOffer(a.bind(this))})):(b={onicecandidate:this.participant.sendIceCandidate.bind(this.participant)},this.wp=new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(b,function(b){return b?console.error(b):void this.generateOffer(a.bind(this))})),console.log(this.getGlobalID()+" waiting for SDP offer")},a.prototype.subscribeToMyRemote=function(){this.showMyRemote=!0},a.prototype.displayMyRemote=function(){return this.showMyRemote},b=!1,a.prototype.mirrorLocalStream=function(a){this.showMyRemote=!0,b=!0,a&&(this.wrStream=a)},a.prototype.isLocalMirrored=function(){return b},a.prototype.getWrStream=function(){return this.wrStream},a.prototype.getWebRtcPeer=function(){return wp},a.prototype.addEventListener=function(a,b){this.ee.addListener(a,b)},a.prototype.playOnlyVideo=function(a,b){this.video=document.createElement("video"),this.video.id="native-video-"+this.getGlobalID(),this.video.autoplay=!0,this.video.controls=!1,this.wrStream?(this.video.src=URL.createObjectURL(this.wrStream),$("#"+b).show(),hideSpinner()):console.log("No @wrStream yet for",this.getGlobalID()),this.videoElements.push({thumb:b,video:this.video}),local&&this.video.setAttribute("muted","muted"),"string"==typeof a?document.getElementById(a).appendChild(this.video):a.appendChild(this.video)},a.prototype.playThumbnail=function(a){var b,c;b=document.createElement("div"),b.className="participant",b.id=this.getGlobalID(),document.getElementById(a).appendChild(b),this.elements.push(b),c=document.createElement("div"),b.appendChild(c),c.appendChild(document.createTextNode(this.getGlobalID())),c.id="name-"+this.getGlobalID(),c.className="name",showSpinner(a),this.playOnlyVideo(b,a)},a.prototype.getID=function(){return id},a.prototype.getParticipant=function(){return this.participant},a.prototype.getGlobalID=function(){return this.participant?this.participant.getID()+"_"+id:id+"_webcam"},a.prototype.init=function(){var a;this.participant.addStream(this),a={audio:!0,video:{mandatory:{maxWidth:640},optional:[{maxFrameRate:15},{minFrameRate:15}]}},getUserMedia(a,function(a){this.wrStream=a,this.ee.emitEvent("access-accepted",null)},function(a){console.error("Access denied",a),this.ee.emitEvent("access-denied",null)})},a.prototype.publishVideoCallback=function(a,b,c){return a?console.error("SDP offer error"):(console.log("Invoking SDP offer callback function - publisher: "+this.getGlobalID()),void kurento.sendRequest("publishVideo",{sdpOffer:b,doLoopback:this.displayMyRemote()||!1},function(a){return function(b,c){b?console.error("Error on publishVideo: "+JSON.stringify(b)):(a.room.emitEvent("stream-published",[{stream:a}]),a.processSdpAnswer(c.sdpAnswer))}}(this)))},a.prototype.startVideoCallback=function(a,b,c){return a?console.error("SDP offer error"):(console.log("Invoking SDP offer callback function - subscribing to: "+this.getGlobalID()),void kurento.sendRequest("receiveVideoFrom",{sender:this.getGlobalID(),sdpOffer:b},function(a,b){a?console.error("Error on recvVideoFrom: "+JSON.stringify(a)):this.processSdpAnswer(b.sdpAnswer)}))},a.prototype.publish=function(){initWebRtcPeer(this.publishVideoCallback)},a.prototype.subscribe=function(){initWebRtcPeer(this.startVideoCallback)},a.prototype.processSdpAnswer=function(a){var b,c;b=new RTCSessionDescription({type:"answer",sdp:a}),console.info(this.getGlobalID()+": SDP answer received, setting the peer connection"),c=this.wp.peerConnection,c.setRemoteDescription(b,function(){var a,b,d,a;if(!local||this.displayMyRemote()){for(this.wrStream=c.getRemoteStreams()[0],console.log("Peer remote stream",this.wrStream),b=0;b<this.videoElements.length;)d=this.videoElements[b].thumb,a=this.videoElements[b].video,a.src=URL.createObjectURL(this.wrStream),a.onplay=function(){var a,b;a=this.id,b=a.split("-"),$("#"+d).show(),hideSpinner(b[2])},b++;this.room.emitEvent("stream-subscribed",[{stream:this}])}},function(a){console.error(this.getGlobalID()+": Error setting SDP to the peer connection: "+JSON.stringify(a))})},a.prototype.unpublish=function(){this.wp?this.wp.dispose():this.wrStream&&(this.wrStream.getAudioTracks().forEach(function(a){a.stop&&a.stop()}),this.wrStream.getVideoTracks().forEach(function(a){a.stop&&a.stop()})),console.log(this.getGlobalID()+": Stream '"+id+"' unpublished")},a.prototype.dispose=function(){var a,b;for(a=function(a){a&&a.parentNode&&a.parentNode.removeChild(a)},b=0;b<this.elements.length;)a(this.elements[b]),b++;for(b=0;b<this.videoElements.length;)a(this.videoElements[b].video),b++;this.wp?this.wp.dispose():this.wrStream&&(this.wrStream.getAudioTracks().forEach(function(a){a.stop&&a.stop()}),this.wrStream.getVideoTracks().forEach(function(a){a.stop&&a.stop()})),console.log(this.getGlobalID()+": Stream '"+id+"' disposed")},a}(),"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:this.KurentoRoom=a}).call(this);
//# sourceMappingURL=kurento-room.min.js.map